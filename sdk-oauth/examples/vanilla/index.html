<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auth Server OAuth Demo - Vanilla JS</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    .card {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }
    h1 {
      margin-top: 0;
      color: #333;
    }
    .btn {
      background: #3b82f6;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }
    .btn:hover {
      background: #2563eb;
    }
    .btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    .btn-danger {
      background: #ef4444;
    }
    .btn-danger:hover {
      background: #dc2626;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .user-details h2 {
      margin: 0 0 0.25rem;
    }
    .user-details p {
      margin: 0;
      color: #6b7280;
    }
    .token-info {
      background: #f3f4f6;
      padding: 1rem;
      border-radius: 6px;
      font-family: monospace;
      font-size: 0.875rem;
      word-break: break-all;
      margin-top: 1rem;
    }
    .error {
      background: #fef2f2;
      color: #dc2626;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    .config-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .form-group label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 500;
    }
    .form-group input {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 1rem;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîê Auth Server OAuth Demo</h1>
    
    <!-- Config Section -->
    <div id="config-section">
      <p>Configure your Auth Server connection:</p>
      <div class="config-form">
        <div class="form-group">
          <label for="server-url">Auth Server URL</label>
          <input type="url" id="server-url" value="http://localhost:3000" placeholder="https://auth.example.com">
        </div>
        <div class="form-group">
          <label for="client-id">Client ID</label>
          <input type="text" id="client-id" placeholder="your-client-id">
        </div>
        <div class="form-group">
          <label for="redirect-uri">Redirect URI</label>
          <input type="url" id="redirect-uri" placeholder="http://localhost:8080/callback.html">
        </div>
        <button class="btn" id="save-config-btn">Save & Initialize</button>
      </div>
    </div>

    <!-- Login Section -->
    <div id="login-section" class="hidden">
      <p>Click the button below to login with Auth Server:</p>
      <button class="btn" id="login-btn">Login with Auth Server</button>
      <button class="btn" id="login-redirect-btn" style="margin-left: 0.5rem; background: #6b7280;">Login (Redirect)</button>
      <p style="margin-top: 1rem; font-size: 0.875rem; color: #6b7280;">
        <a href="#" id="change-config">Change configuration</a>
      </p>
    </div>

    <!-- Error Section -->
    <div id="error-section" class="hidden">
      <div class="error" id="error-message"></div>
    </div>

    <!-- User Section -->
    <div id="user-section" class="hidden">
      <div class="user-info">
        <div class="avatar" id="user-avatar">üë§</div>
        <div class="user-details">
          <h2 id="user-name">User</h2>
          <p id="user-email">email@example.com</p>
        </div>
      </div>
      <button class="btn btn-danger" id="logout-btn">Logout</button>
      
      <div class="token-info">
        <strong>Access Token:</strong><br>
        <span id="access-token">-</span>
      </div>
    </div>
  </div>

  <!-- Using ES modules -->
  <script type="module">
    // Import from local build or CDN
    // For local development, you'll need to build the SDK first
    // import { AuthServerClient } from '../../dist/index.mjs';
    
    // For this demo, we'll inline a minimal version
    // In production, use: import { AuthServerClient } from '@authserver/oauth-sdk';

    // ============================================================================
    // Minimal inline SDK (for demo purposes)
    // ============================================================================
    
    function generateRandomString(length = 64) {
      const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      const randomValues = new Uint8Array(length);
      crypto.getRandomValues(randomValues);
      return Array.from(randomValues).map((v) => charset[v % charset.length]).join('');
    }

    async function sha256Base64Url(input) {
      const encoder = new TextEncoder();
      const data = encoder.encode(input);
      const digest = await crypto.subtle.digest('SHA-256', data);
      const base64 = btoa(String.fromCharCode(...new Uint8Array(digest)));
      return base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    class AuthServerClient {
      constructor(config) {
        this.config = {
          serverUrl: config.serverUrl.replace(/\/$/, ''),
          clientId: config.clientId,
          redirectUri: config.redirectUri,
          scopes: config.scopes || ['openid', 'profile', 'email'],
          storagePrefix: config.storagePrefix || 'authserver',
        };
        this.popup = null;
      }

      getStorageKey(name) {
        return `${this.config.storagePrefix}_${name}`;
      }

      getTokens() {
        try {
          const value = localStorage.getItem(this.getStorageKey('tokens'));
          return value ? JSON.parse(value) : null;
        } catch {
          return null;
        }
      }

      setTokens(tokens) {
        localStorage.setItem(this.getStorageKey('tokens'), JSON.stringify(tokens));
      }

      getUser() {
        try {
          const value = localStorage.getItem(this.getStorageKey('user'));
          return value ? JSON.parse(value) : null;
        } catch {
          return null;
        }
      }

      setUser(user) {
        localStorage.setItem(this.getStorageKey('user'), JSON.stringify(user));
      }

      clearStorage() {
        localStorage.removeItem(this.getStorageKey('tokens'));
        localStorage.removeItem(this.getStorageKey('user'));
        localStorage.removeItem(this.getStorageKey('pkce'));
        localStorage.removeItem(this.getStorageKey('state'));
      }

      isAuthenticated() {
        const tokens = this.getTokens();
        if (!tokens) return false;
        
        try {
          const payload = JSON.parse(atob(tokens.access_token.split('.')[1]));
          return payload.exp * 1000 > Date.now();
        } catch {
          return false;
        }
      }

      getState() {
        return {
          isAuthenticated: this.isAuthenticated(),
          tokens: this.getTokens(),
          user: this.getUser(),
        };
      }

      async loginWithPopup() {
        const codeVerifier = generateRandomString(64);
        const codeChallenge = await sha256Base64Url(codeVerifier);
        const state = generateRandomString(32);

        localStorage.setItem(this.getStorageKey('pkce'), JSON.stringify({ codeVerifier, codeChallenge }));
        localStorage.setItem(this.getStorageKey('state'), state);

        const params = new URLSearchParams({
          client_id: this.config.clientId,
          response_type: 'code',
          redirect_uri: this.config.redirectUri,
          scope: this.config.scopes.join(' '),
          state: state,
          code_challenge: codeChallenge,
          code_challenge_method: 'S256',
        });

        const authUrl = `${this.config.serverUrl}/oauth/authorize?${params.toString()}`;

        return new Promise((resolve, reject) => {
          const left = (window.screen.width - 500) / 2;
          const top = (window.screen.height - 600) / 2;

          this.popup = window.open(
            authUrl,
            'authserver_login',
            `width=500,height=600,left=${left},top=${top},scrollbars=yes,resizable=yes`
          );

          if (!this.popup) {
            reject(new Error('Failed to open popup. Please allow popups.'));
            return;
          }

          const messageHandler = async (event) => {
            let data = event.data;
            
            if (typeof data !== 'object' || data.type !== 'oauth_callback') {
              return;
            }

            window.removeEventListener('message', messageHandler);
            this.popup?.close();
            this.popup = null;

            if (data.error) {
              reject(new Error(data.error_description || data.error));
              return;
            }

            if (data.code) {
              try {
                const tokens = await this.exchangeCode(data.code, data.state);
                resolve(tokens);
              } catch (err) {
                reject(err);
              }
            }
          };

          window.addEventListener('message', messageHandler);

          const pollTimer = setInterval(() => {
            if (this.popup?.closed) {
              clearInterval(pollTimer);
              window.removeEventListener('message', messageHandler);
              this.popup = null;
              reject(new Error('Login cancelled'));
            }
          }, 500);
        });
      }

      loginWithRedirect() {
        sha256Base64Url(generateRandomString(64)).then(async (codeChallenge) => {
          const codeVerifier = generateRandomString(64);
          const realCodeChallenge = await sha256Base64Url(codeVerifier);
          const state = generateRandomString(32);

          localStorage.setItem(this.getStorageKey('pkce'), JSON.stringify({ codeVerifier, codeChallenge: realCodeChallenge }));
          localStorage.setItem(this.getStorageKey('state'), state);

          const params = new URLSearchParams({
            client_id: this.config.clientId,
            response_type: 'code',
            redirect_uri: this.config.redirectUri,
            scope: this.config.scopes.join(' '),
            state: state,
            code_challenge: realCodeChallenge,
            code_challenge_method: 'S256',
          });

          window.location.href = `${this.config.serverUrl}/oauth/authorize?${params.toString()}`;
        });
      }

      async handleRedirectCallback() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('code');
        const state = params.get('state');
        const error = params.get('error');

        if (error) {
          throw new Error(params.get('error_description') || error);
        }

        if (!code) {
          throw new Error('No authorization code received');
        }

        const tokens = await this.exchangeCode(code, state);
        window.history.replaceState({}, document.title, window.location.pathname);
        return tokens;
      }

      async exchangeCode(code, state) {
        const storedState = localStorage.getItem(this.getStorageKey('state'));
        if (state !== storedState) {
          throw new Error('Invalid state parameter');
        }

        const pkceData = localStorage.getItem(this.getStorageKey('pkce'));
        if (!pkceData) {
          throw new Error('PKCE data not found');
        }

        const { codeVerifier } = JSON.parse(pkceData);

        const response = await fetch(`${this.config.serverUrl}/oauth/token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            grant_type: 'authorization_code',
            code,
            redirect_uri: this.config.redirectUri,
            client_id: this.config.clientId,
            code_verifier: codeVerifier,
          }),
        });

        localStorage.removeItem(this.getStorageKey('pkce'));
        localStorage.removeItem(this.getStorageKey('state'));

        if (!response.ok) {
          const error = await response.json().catch(() => ({}));
          throw new Error(error.error_description || error.error || 'Token exchange failed');
        }

        const tokens = await response.json();
        this.setTokens(tokens);

        try {
          await this.fetchUserInfo();
        } catch {}

        return tokens;
      }

      async fetchUserInfo() {
        const tokens = this.getTokens();
        if (!tokens) throw new Error('Not authenticated');

        const response = await fetch(`${this.config.serverUrl}/oauth/userinfo`, {
          headers: { Authorization: `Bearer ${tokens.access_token}` },
        });

        if (!response.ok) throw new Error('Failed to fetch user info');

        const user = await response.json();
        this.setUser(user);
        return user;
      }

      async logout() {
        const tokens = this.getTokens();
        if (tokens?.access_token) {
          try {
            await fetch(`${this.config.serverUrl}/oauth/revoke`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({
                token: tokens.access_token,
                client_id: this.config.clientId,
              }),
            });
          } catch {}
        }
        this.clearStorage();
      }
    }

    // ============================================================================
    // Demo App
    // ============================================================================

    let auth = null;

    const configSection = document.getElementById('config-section');
    const loginSection = document.getElementById('login-section');
    const userSection = document.getElementById('user-section');
    const errorSection = document.getElementById('error-section');

    function showError(message) {
      document.getElementById('error-message').textContent = message;
      errorSection.classList.remove('hidden');
      setTimeout(() => errorSection.classList.add('hidden'), 5000);
    }

    function updateUI() {
      if (!auth) {
        configSection.classList.remove('hidden');
        loginSection.classList.add('hidden');
        userSection.classList.add('hidden');
        return;
      }

      configSection.classList.add('hidden');
      const state = auth.getState();

      if (state.isAuthenticated) {
        loginSection.classList.add('hidden');
        userSection.classList.remove('hidden');

        const user = state.user || {};
        document.getElementById('user-name').textContent = user.name || 'User';
        document.getElementById('user-email').textContent = user.email || '';
        document.getElementById('user-avatar').textContent = user.name ? user.name[0].toUpperCase() : 'üë§';
        document.getElementById('access-token').textContent = 
          state.tokens?.access_token?.substring(0, 50) + '...';
      } else {
        loginSection.classList.remove('hidden');
        userSection.classList.add('hidden');
      }
    }

    // Save config
    document.getElementById('save-config-btn').addEventListener('click', () => {
      const serverUrl = document.getElementById('server-url').value;
      const clientId = document.getElementById('client-id').value;
      const redirectUri = document.getElementById('redirect-uri').value || (window.location.origin + '/callback.html');

      if (!serverUrl || !clientId) {
        showError('Please fill in Server URL and Client ID');
        return;
      }

      // Save to localStorage
      localStorage.setItem('oauth_demo_config', JSON.stringify({ serverUrl, clientId, redirectUri }));

      // Initialize client
      auth = new AuthServerClient({ serverUrl, clientId, redirectUri });
      updateUI();
    });

    // Change config
    document.getElementById('change-config').addEventListener('click', (e) => {
      e.preventDefault();
      auth = null;
      updateUI();
    });

    // Login with popup
    document.getElementById('login-btn').addEventListener('click', async () => {
      try {
        await auth.loginWithPopup();
        updateUI();
      } catch (error) {
        showError(error.message);
      }
    });

    // Login with redirect
    document.getElementById('login-redirect-btn').addEventListener('click', () => {
      auth.loginWithRedirect();
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      await auth.logout();
      updateUI();
    });

    // Initialize on load
    const savedConfig = localStorage.getItem('oauth_demo_config');
    if (savedConfig) {
      try {
        const config = JSON.parse(savedConfig);
        document.getElementById('server-url').value = config.serverUrl;
        document.getElementById('client-id').value = config.clientId;
        document.getElementById('redirect-uri').value = config.redirectUri;
        
        auth = new AuthServerClient(config);
      } catch {}
    }

    // Handle redirect callback
    if (window.location.search.includes('code=')) {
      if (auth) {
        auth.handleRedirectCallback()
          .then(() => updateUI())
          .catch((err) => showError(err.message));
      }
    }

    updateUI();
  </script>
</body>
</html>
