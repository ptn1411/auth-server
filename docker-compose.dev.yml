# Auth Server - Docker Compose for Development
# 
# Setup domain ảo giống Laragon:
#   - auth.local      -> Frontend
#   - api.auth.local  -> Backend API
#
# Cách dùng:
#   1. Thêm vào file hosts (chạy CMD as Admin):
#      echo 127.0.0.1 auth.local api.auth.local >> C:\Windows\System32\drivers\etc\hosts
#
#   2. Start services:
#      docker-compose -f docker-compose.dev.yml up -d
#
#   3. Truy cập:
#      - http://auth.local        (Frontend)
#      - http://api.auth.local    (Backend API)

version: '3.8'

services:
  # ==========================================================================
  # MySQL Database
  # ==========================================================================
  mysql:
    image: mysql:8.0
    container_name: authserver-mysql-dev
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpassword}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-auth_server}
      MYSQL_USER: ${MYSQL_USER:-authserver}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-authpassword}
    ports:
      - "${MYSQL_PORT:-3307}:3306"
    volumes:
      - mysql_data_dev:/var/lib/mysql
      - ./docker/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD:-rootpassword}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - authserver-dev

  # ==========================================================================
  # Auth Server Backend (Rust)
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: authserver-backend-dev
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      DATABASE_URL: mysql://${MYSQL_USER:-authserver}:${MYSQL_PASSWORD:-authpassword}@mysql:3306/${MYSQL_DATABASE:-auth_server}
      JWT_PRIVATE_KEY_FILE: /app/keys/private.pem
      JWT_PUBLIC_KEY_FILE: /app/keys/public.pem
      ACCESS_TOKEN_EXPIRY_SECS: ${ACCESS_TOKEN_EXPIRY_SECS:-900}
      REFRESH_TOKEN_EXPIRY_SECS: ${REFRESH_TOKEN_EXPIRY_SECS:-604800}
      SERVER_HOST: 0.0.0.0
      SERVER_PORT: 3000
      APP_NAME: ${APP_NAME:-Auth Server}
      APP_URL: https://api.auth.local
      WEBAUTHN_RP_ID: auth.local
      WEBAUTHN_RP_NAME: ${WEBAUTHN_RP_NAME:-Auth Server}
      WEBAUTHN_RP_ORIGIN: https://auth.local
      RUST_LOG: ${RUST_LOG:-auth_server=debug,tower_http=debug}
    volumes:
      - ./keys:/app/keys:ro
    networks:
      - authserver-dev

  # ==========================================================================
  # Frontend (React + Vite)
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: docker/Dockerfile.frontend
      args:
        VITE_API_URL: https://api.auth.local
    container_name: authserver-frontend-dev
    restart: unless-stopped
    depends_on:
      - backend
    networks:
      - authserver-dev

  # ==========================================================================
  # Nginx Reverse Proxy - Domain routing with HTTPS
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: authserver-nginx-dev
    restart: unless-stopped
    depends_on:
      - backend
      - frontend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx/dev-ssl.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - authserver-dev

networks:
  authserver-dev:
    driver: bridge

volumes:
  mysql_data_dev:
    driver: local
